<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="description" itemprop="description" content="COVID-19 Stats" />
  <meta itemprop="name" content="COVID-19 Stats" />
  <meta itemprop="image" content="http://sig.gy/covid19stats/thumbnail.png" />

  <!-- Facebook Open Graph -->
  <meta property="og:title" content="COVID-19 Stats" />
  <meta property="og:description" content="COVID-19 Stats" />
  <meta property="og:url" content="http://sig.gy/covid19stats/" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="http://sig.gy/covid19stats/thumbnail.png" />
  <meta property="og:site_name" content="COVID-19 Stats" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="COVID-19 Stats" />
  <meta name="twitter:title" content="COVID-19 Stats" />
  <meta name="twitter:description" content="COVID-19 Stats" />
  <meta name="twitter:image:src" content="http://sig.gy/covid19stats/thumbnail.png" />
  <meta name="twitter:url" content="http://sig.gy/covid19stats/" />

  <title>COVID-19 Stats</title>

  <link rel="canonical" href="http://sig.gy/covid19stats/" />

  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" rel="stylesheet">

  <style>
    body {
      background-color: white;
    }

    p {
      margin: 0;
    }

    .github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}
  </style>
</head>
<body>
  <div id="states"></div>
  <div id="counties"></div>

  <a href="https://github.com/siggy/covid19stats" class="github-corner" aria-label="Fork me on Github" title="Fork me on Github">
    <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg>
  </a>

  Based on:
  <a href='https://github.com/nytimes/covid-19-data'>github.com/nytimes/covid-19-data</a>
  <a href='https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/'>www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/totals/</a>
  <a href='https://covidtracking.com'>covidtracking.com</a>

  <script>

    Promise.all([
      fetch('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv')
        .then((response) => {
          return response.ok ? response.text() : Promise.reject(response.status);
        }),
      fetch('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv')
      .then((response) => {
        return response.ok ? response.text() : Promise.reject(response.status);
      }),
      fetch('co-est2019-alldata-min.csv')
        .then((response) => {
          return response.ok ? response.text() : Promise.reject(response.status);
        }),
      fetch('https://covidtracking.com/api/states')
        .then((response) => {
          return response.ok ? response.json() : Promise.reject(response.status);
        }),
    ])
    .then(responses => {
      const countyCases = responses[0].split('\n');
      const stateCases = responses[1].split('\n');
      const pops = responses[2].split('\n');
      const tests = responses[3];

      pops.shift();

      const popsByFips = new Map();
      pops.forEach((pop) => {
        const p = pop.split(',');
        popsByFips.set(p[0], parseInt(p[3]));
      });

      const testsByFips = new Map();
      tests.forEach((test) => {
        testsByFips.set(test.fips, test);
      });

      // states

      // TODO: refactor this with county data processing
      const stateHeaders = stateCases.shift().split(',');
      stateHeaders.push('population');
      stateHeaders.push('cases/1M');
      stateHeaders.push('deaths/1M');
      stateHeaders.push('tests');
      stateHeaders.push('pos test %');
      stateHeaders.push('tests/1M');

      const stateRowsByDate = new Map();
      stateCases.forEach((line) => {
        const row = line.split(',');
        if (!stateRowsByDate.has(row[0])) {
          stateRowsByDate.set(row[0], [])
        }
        stateRowsByDate.get(row[0]).push(row);
      });

      const statesLatestDay = [];
      Array.from(stateRowsByDate)[stateRowsByDate.size-1][1].forEach((state) => {
        const name = state[1];
        const fips = state[2];
        if (fips !== '' && popsByFips.has(fips)) {
          const pop = popsByFips.get(fips);
          state.push(popsByFips.get(fips));

          const popPer1M = pop / 1000000;
          state.push(Math.round(state[3] / popPer1M));
          state.push(Math.round(state[4] / popPer1M));

          statesLatestDay.push(state);

          if (testsByFips.has(fips)) {
            const positiveTests = testsByFips.get(fips).positive;
            const totalTests = testsByFips.get(fips).totalTestResults;
            state.push(totalTests);
            state.push(Math.round(100 * positiveTests / totalTests));
            state.push(Math.round(totalTests / popPer1M));
          } else {
            console.warn('state fips not found in test data: ' + state);
          }

          // TODO: Guam, Puerto Rico, Virgin Islands
        } else {
          console.warn('state fips not found: ' + state);
        }
      });

      const hotStates = new Handsontable(document.getElementById('states'), {
        data: statesLatestDay,
        colHeaders: stateHeaders,
        autoColumnSize: {
          samplingRatio: 23
        },
        multiColumnSorting: {
          indicator: true
        },
        licenseKey: 'non-commercial-and-evaluation'
      });

      // counties

      const colHeaders = countyCases.shift().split(',');
      colHeaders.push('population');
      colHeaders.push('cases/1M');
      colHeaders.push('deaths/1M');

      const rowsByDate = new Map();
      countyCases.forEach((line) => {
        const row = line.split(',');
        if (!rowsByDate.has(row[0])) {
          rowsByDate.set(row[0], [])
        }
        rowsByDate.get(row[0]).push(row);
      });

      const latestDay = [];
      Array.from(rowsByDate)[rowsByDate.size-1][1].forEach((county) => {
        const name = county[1];
        const fips = county[3];
        if (name !== 'Unknown' && fips !== '' && popsByFips.has(fips)) {
          const pop = popsByFips.get(fips);
          county.push(popsByFips.get(fips));

          const popPer1M = pop / 1000000;
          county.push(Math.round(county[4] / popPer1M));
          county.push(Math.round(county[5] / popPer1M));

          latestDay.push(county);
        } else if (name === 'New York City') {
          const pop =
            popsByFips.get('36005') + // Bronx
            popsByFips.get('36047') + // Kings
            popsByFips.get('36061') + // New York
            popsByFips.get('36081') + // Queens
            popsByFips.get('36085');  // Richmond

          county.push(pop);
          const popPer1M = pop / 1000000;
          county.push(Math.round(county[4] / popPer1M));
          county.push(Math.round(county[5] / popPer1M));

          latestDay.push(county);
        } else {
          console.warn('not found: ' + county);
        }
      });

      const hotCounties = new Handsontable(document.getElementById('counties'), {
        data: latestDay,
        colHeaders: colHeaders,
        autoColumnSize: {
          samplingRatio: 23
        },
        multiColumnSorting: {
          indicator: true
        },
        licenseKey: 'non-commercial-and-evaluation'
      });
    });

  </script>
</body>
</html>
